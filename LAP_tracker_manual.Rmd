---
title:           "Εγχειρίδιο λειτουργίας ηλιοστάτη."
author:          "Νάτσης Αθανάσιος"
date:            "`r Sys.Date()`"
site:            bookdown::bookdown_site
output:          bookdown::gitbook
# documentclass:  book
documentclass:   article
classoption:     [a4paper,twoside,titlepage,12pt]
#bibliography:    [bib/thesis.bib]
#biblio-style:    apalike
link-citations:  yes
colorlinks:      yes
# description:    "This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook."
lot: true
lof: true
# always_allow_html: yes
# output:         bookdown::word_document2
---

<!-- enable caching globally -->
```{r setup, include=FALSE}
require(knitr)
# opts_chunk$set(cache = TRUE)
opts_chunk$set(out.width = '80%', fig.align = 'center')
```


<!-- _output.yml ouput build instructions -->
<!-- **use build all from Rstudio** -->
<!-- To compile this example to PDF, you need to install XeLaTeX. -->


<!--chapter:end:index.Rmd-->



\newpage 
# {-}

\  

\  
\vfill
\  

\  

----------------------------------------------------------------------------------------------------------------------
    Η εργασία αυτή διανέμεται υπό την άδεια:
    **Creative Commons - Αναφορά Δημιουργού -**
    **Μη Εμπορική Χρήση - Παρόμοια Διανομή 4.0 Διεθνές.**
    [http://creativecommons.org/licenses/by-nc-sa/4.0/](http://creativecommons.org/licenses/by-nc-sa/4.0/)
----------------------------------------------------------------------------------------------------------------------

\  
\vfill \  
\  

<!-- -------------------------------------------------------------------------------------------------------------------- -->
<!--    Για διορθώσεις και προσθήκες επικοινωνήστε με Thanasisn [github.com/thanasisn](https://github.com/thanasisn). -->
<!-- -------------------------------------------------------------------------------------------------------------------- -->

\  
\vfill \  
\  

**_Σημείωση:_ Ο πηγαίος κώδικας (source code) που παρατίθεται εδώ είναι ένα παράδειγμα εφαρμογής κάποιων τεχνικών. Σε περίπτωση που θέλετε να τον χρησιμοποιήσετε, προτείνουμε να δοκιμαστεί η καταλληλότητα του για την επιθυμητή χρήση, πρώτα σε μη σημαντικές εφαρμογές (non-critical). Τα παραδείγματα κώδικα εδώ, διαφέρουν από αυτά που χρησιμοποιούμε, λόγω της συνεχής εξέλιξης και βελτίωσης κατά την χρήση τους.**




\newpage

\ \
\vfill
\ \

# Εισαγωγή. {-#intro}

Το παρόν είναι ένας ανεπίσημος οδηγός για τη χρήση και τη λειτουργία του ηλιοστάτη του ΕΦΑ. Συντάχτηκε από της διαθέσιμες πληροφορίες για τον ηλιοστάτη καθώς και από την εμπειρία που αποκομίσαμε κατά τη χρήση του. Σκοπός μας είναι να βοηθήσει στην περαιτέρω ανάπτυξη και χρήση του, γι' αυτό ζητούμε την συνεισφορά σας στη βελτίωσή του. Για διορθώσεις και προσθήκες μπορείτε να επικοινωνήσετε με τον [Νάτση  Αθανάσιο](mailto:natsisthanasis@gmail.com) (natsisthanasis@gmail.com) ή το Εργαστήριο Φυσικής της Ατμόσφαιρας του Α.Π.Θ.

\ \
\vfill
\ \

<!--chapter:end:010-intro.Rmd-->


\newpage

# Ο ηλιοστάτης του Εργαστηρίου Φυσικής της Ατμόσφαιρας. {#tracker}

## Περιγραφή tracker (ηλιοστάτη). {#trackerdescription}

Η συσκευή αποτελείται από σώμα αλουμινίου, δύο άξονες κίνησης, δύο κινητήρες και ηλεκτρονικό σύστημα ελέγχου.
Οι άξονες έχουν ομόκεντρα γρανάζια τα οποία τίθενται σε κίνηση από stepper motors μέσω κατάλληλου ιμάντα (Εικόνα \@ref(fig:trackerinside)).
Η επικοινωνία με το σύστημα ελέγχου γίνεται μέσω σειριακής θύρας (πραγματικής ή εικονικής με τη χρήση μετατροπέα usb/serial).

Και οι δύο κάθετοι άξονες (αζιμούθιου και ζενίθ) έχουν τις ίδιες δυνατότητες και χαρακτηριστικά μεταξύ τους, η λειτουργία τους είναι πανομοιότυπη και μπορούν να κινηθούν ταυτόχρονα και ανεξάρτητα ο ένας από τον άλλο. 

Οι κινητήρες του tracker μπορούν να κινηθούν με σταθερό βήμα $0.6^\circ$ ο καθένας.
Στο πρώτο μοντέλο του ηλιοστάτη, για τη μετάδοση της κίνησης, οι κινητήρες έχουν στο γρανάζι τους 12 δόντια και κινούν μέσω ιμάντα τους άξονες, που έχουν από 70 δόντια ο καθένας. 
Αυτό δίνει την δυνατότητα οι άξονες του ηλιοστάτη να κινούνται με διακριτό βήμα $0.6^\circ \cdot 12 / 70 \simeq 0.10286^\circ$ για το παλιό μοντέλο. Τα καινούρια μοντέλα του ηλιοστάτη, αντίστοιχα έχουν βήμα ${0.125}^\circ$.

Για την εκτέλεση μιας πλήρους περιστροφής του κάθε άξονα ο κινητήρας πρέπει να κάνει $360^\circ / (0.6^\circ \cdot 12 / 70) = 3500$ βήματα στο παλιό μοντέλο και $360^\circ / {0.125}^\circ = 2880$ βήματα στα καινούρια μοντέλα.
Ενώ η μέγιστη ταχύτατα περιστροφής των κινητήρων είναι περίπου μία περιστροφή ανά $15$ δευτερόλεπτα. 

```{r trackerinside, echo=F, fig.cap="Εσωτερικό του πρώτου μοντέλου tracker. Φαίνονται τα κύρια γρανάζια των αξόνων, ο κινητήρας του αζιμούθιου άξονα και το ηλεκτρονικό σύστημα ελέγχου, καθώς και το CHP\ 1.", out.width = '50%', fig.env='img'}
knitr::include_graphics("/home/athan/Aerosols/Photos/EL/20160615_Tracker2/20160615_125806.jpg")
```




## Επικοινωνία με τον tracker. {#tracker_communication}

Οι κινητήρες ελέγχονται από μικροελεγκτή (microcontroller), ο οποίος βρίσκεται μέσα στο κύριο σώμα της συσκευής. Ο μικροελεγκτής είναι ήδη προγραμματισμένος να εκτελεί άμεσα τις εντολές που λαμβάνει, μέσω της σειριακής επικοινωνίας.

Το λειτουργικό σύστημα του υπολογιστή αναγνωρίζει τη σειριακή σύνδεση με τον microcontroller ως κάποια θύρα `COM#` στα Windows ή ως `/dev/ttyUSB#`, `/dev/ttyS#` σε GNU/Linux. Οι εντολές μεταδίδονται στη συσκευή, γράφοντάς τις σε κάποια από αυτές τις διευθύνσεις. Αντίστοιχα, οι απαντήσεις των εντολών διαβάζονται από την ίδια διεύθυνση. Τυπικά, η επικοινωνία είναι πανομοιότυπη με την εγγραφή (write) και την ανάγνωση (read) κειμένου (string) από αρχείο, με βήμα, μία γραμμή  ανά εντολή. Κάθε γραμμή τερματίζεται με τον χαρακτήρα `'\r'` (Carriage return, CR).

Η σειριακή επικοινωνία μπορεί να επιτευχθεί με άμεση σύνδεση του μικροελεγκτή σε σειριακή θύρα του υπολογιστή. Είτε, μέσω μετατροπέα USB UART (adapter usb to serial) σε θύρα USB του ηλεκτρονικού υπολογιστή (Σχήμα \@ref(fig:trackercon)). Στην περίπτωσή μας χρησιμοποιούμε τον μετατροπέα 'FT232 USB-Serial (UART) IC'. Υπάρχει το ενδεχόμενο κάποιοι μετατροπείς UART να μην επιτυγχάνουν σωστή επικοινωνία, λόγω των τεχνικών τους χαρακτηριστικών.


```{r echo=F}
system('echo \'
digraph trackercon {

  # Intialization of graph attributes
  graph [align   = center,
         layout  = dot,
         rankdir = LR,
         dpi     = 400]

  # Initialization of node attributes
  node [shape = box,
        fontsize = 10,
        margin = 0.001]

    " Computer " -> " USB to RS-232 " -> " Power brick " -> " microcontroler " [dir="both"]

    subgraph cluster { label="Tracker assembly"
        " microcontroler " -> "step motors"
    }
}
\' > figure/trackercon.dot')
#system('dot -Tpdf graph.dot -o graph.pdf')
system('dot -Tpng figure/trackercon.dot -o figure/trackercon.png')
```
```{r trackercon, echo=F, fig.cap="Διάγραμμα επικοινωνίας του tracker με τον υπολογιστή."}
knitr::include_graphics("figure/trackercon.png")
```

### Επικοινωνία με τον Tracker σε περιβάλλον MatLab {#tracker_matlab}

Σε αυτό το στάδιο περιγράφονται οι εντολές και οι παράμετροι που απαιτούνται προκειμένου να επιτευχθεί επικοινωνία με τον Tracker σε περιβάλλον MatLab. Το MatLab διαθέτει έτοιμες συναρτήσεις και εντολές για την επικοινωνία με ένα Serial Object, με την προϋπόθεση να έχουμε εγκατεστημένο το Instrument Control Toolbox. Προτού ανοίξουμε την σειριακή θύρα, πρέπει να δημιουργηθεί ένα Serial Object χρησιμοποιώντας την εντολή `serial`, εισάγοντας τις αντίστοιχες ρυθμίσεις του Tracker. Στο MatLab snippet που ακολουθεί, ορίζεται μια struct με όνομα 'Tracker', η οποία περιλαμβάνει τόσο τις ρυθμίσεις της σειριακής επικοινωνίας (SerialConfiguration), όσο και αυτό καθαυτό το Serial Object (SerialPort). Σημειώνεται ότι στον συγκεκριμένο κώδικα έχει γίνει hard coding της Communication Port σε `COM4`, καθώς ξέρουμε ότι σε αυτήν την θύρα είναι συνδεδεμένο το καλώδιο USB του Tracker. Για την αυτόματη εύρεση της COM Port μπορεί να χρησιμοποιηθεί η εντολή `instrfindall` που εντοπίζει όλες τις ενεργές συνδέσεις και επιστρέφει τις θύρες COM, στις οποίες βρίσκονται συνδεδεμένες συσκευές.

```Matlab 
% Set Tracker's Serial Port Configuration and create the Serial Object
Tracker.SerialConfiguration.COM             = 'COM4';
Tracker.SerialConfiguration.BaudRate        = 4800;
Tracker.SerialConfiguration.DataBit         = 8;
Tracker.SerialConfiguration.StopBit         = 1;
Tracker.SerialConfiguration.Parity          = 'none';
Tracker.SerialConfiguration.Terminator      = 'CR';
Tracker.SerialConfiguration.Timeout         = 50;
Tracker.SerialConfiguration.InputBufferSize = 5000;

Tracker.SerialPort = serial(Tracker.SerialConfiguration.COM,...
    'BaudRate',Tracker.SerialConfiguration.BaudRate,...
    'DataBit',Tracker.SerialConfiguration.DataBit, ...
    'StopBit',Tracker.SerialConfiguration.StopBit, ...
    'Parity',Tracker.SerialConfiguration.Parity, ...
    'Terminator',Tracker.SerialConfiguration.Terminator, ...
    'Timeout',Tracker.SerialConfiguration.Timeout, ...
    'InputBufferSize',Tracker.SerialConfiguration.InputBufferSize);
```

Η παράμετρος `InputBufferSize` επιτρέπει τον έλεγχο του αριθμού των bytes που μπορούν να κρατηθούν στον buffer του μικροεπεξεργαστή και εφόσον δοθεί μια μεγάλη τιμή (όπως στην περίπτωσή μας, 5000), μπορούμε να δίνουμε εντολές στον Tracker την μία πίσω από την άλλη σε stack. Υπόψιν ότι ο μικροεπεξεργαστής σε αυτήν την περίπτωση θα επιστρέψει ως πρώτη απάντηση το αποτέλεσμα της εντολής που ολοκληρώθηκε πρώτη και στην συνέχεια με την ίδια λογική τις υπόλοιπες. Αφού δημιουργηθεί το Serial Object, χρησιμοποιώντας τις εντολές `fopen` και `fclose` μπορούμε να ανοίξουμε και να κλείσουμε αντίστοιχα την σειριακή θύρα. Με τις εντολές `fprintf` και `fscanf` δίνουμε εντολή στον Tracker και λαμβάνουμε την απάντησή του αντίστοιχα σε μορφή ASCII. Παρακάτω παρουσιάζεται ένα παράδειγμα για την εύρεση της θέσης (step) του Αζιμούθιου άξονα

```Matlab
% Send the Command to the Tracker
fprintf(Tracker.SerialPort, 'AZ?');
```
```Matlab
% Wait for the Tracker's microntroller to fill the buffer (Typically 0.5 sec)
pause(time_delay)
```
```Matlab
% Get the Tracker's answer
[answer, bytes, msg_err] = fscanf(Tracker.SerialPort);
```

Με τις παραπάνω εντολές, ο Tracker θα απαντήσει με την θέση σε βήματα του Αζιμούθιου άξονα (πχ AZ:6000<cr>) στην μεταβλητή `answer`, τον αριθμό των bytes που στάλθηκαν (8 στην συγκεκριμένη περίπτωση) στην μεταβλητή `bytes` και τυχόν μηνύματα σφάλματος κατά την σειριακή επικοινωνία στην μεταβλητή `msg_err`. Άλλες χρήσιμες εντολές και παράμετροι για τον έλεγχο και την ορθή επικοινωνία με τον Tracker είναι η `Tracker.SerialPort.BytesAvailable`, η οποία επιστρέφει τον αριθμό των bytes που υπάρχουν διαθέσιμα στον buffer του microcontroller, η `flushinput(Tracker.SerialPort)` και η `flushoutput(Tracker.SerialPort)` που αδειάζουν τον Input και Output buffer αντίστοιχα.



## Σειρά σύνδεσης. {#tracker_connection}

Μετά από δοκιμές όλων των δυνατών συνδυασμών της σειρά σύνδεσης. Διαπιστώσαμε ότι για την επιτυχή επικοινωνία πρέπει να έχει γίνει η σύνδεση (4) και μετά να ακολουθηθεί η σειρά των συνδέσεων (1-2-3) ή (3-2-1) όπως φαίνονται στο Σχήμα \@ref(fig:trackercomm).


```{r echo=F}
system('echo \'
digraph trackercomm {

  # Intialization of graph attributes
  graph [align   = center,
         layout  = dot,
         rankdir = LR,
         dpi     = 400]

  # Initialization of node attributes
  node [shape = box,
        fontsize = 10,
        margin = 0.001]

    " Computer "      -> " USB to RS-232 " [dir="both",label="4"];
    " Power cable "   -> " Control box "   [dir="both",label="1"];
    " USB to RS-232 " -> " Control box "   [dir="both",label="3"];
    " Control box "   -> " Tracker "       [dir="both",label="2"]; 
}
\' > figure/trackercomm.dot')
#system('dot -Tpdf graph.dot -o graph.pdf')
system('dot -Tpng figure/trackercomm.dot -o figure/trackercomm.png')
```
```{r trackercomm, echo=F, fig.cap="Διάγραμμα συνδέσεων του tracker, κατάλληλη σειρά σύνδεσης (1-2-3) ή (3-2-1)."}
knitr::include_graphics("figure/trackercomm.png")
```


<!--chapter:end:020-description.Rmd-->


\newpage

# Λειτουργία - Προγραμματισμός tracker. {#trackeroperation}

## Γενικές πληροφορίες

Κατά τη λειτουργία πρέπει να δοθεί προσοχή, διότι δεν υπάρχει μηχανικός περιορισμός που να αποτρέπει την περιστροφή του άξονα κατά γωνίες μεγαλύτερες του πλήρη κύκλου.
Αυτό μπορεί να προκαλέσει πρόβλημα γιατί το καλώδιο του tracker αλλά και τον οργάνων μπορεί να τυλιχτούν γύρω από τον άξονα και να καταστραφούν.
Επίσης, σε περίπτωση που η συσκευή δεν έχει τοποθετηθεί μόνιμα π.χ. σε τρίποδα, μπορεί η περιστροφή να τραβήξει τα καλώδια και να ρίξει τη συσκευή.

Ο tracker όταν του δοθεί εντολή (reset), θα προσπαθήσει να μηδενίσει τον μετρητή βήματος αφού μετακινηθεί σε μία γνωστή θέση.
Αυτό γίνεται με την περιστροφή του άξονα, μέχρι να φτάσει στη συγκεκριμένη θέση, την οποία αναγνωρίζει με μία φωτοδίοδο.
Προσοχή, σε περίπτωση που δεν πάρει σήμα από τη φωτοδίοδο, θα συνεχίσει να περιστρέφεται ασταμάτητα.
Αυτό μπορεί να συμβεί, αν το καπάκι είναι ανοιχτό σε έντονο φως ή αν υπάρχει κάποιο πρόβλημα επικοινωνίας με τη φωτοδίοδο.

Ο tracker θα μηδενίσει τον κάθε άξονα στη θέση `'5000'`. Από εκεί και πέρα μπορεί να κινηθεί και προς τις δύο κατευθύνσεις.
Προσοχή, αν το βήμα γίνει αρνητικό από κάποια εντολή ή αν γίνει μεγαλύτερο του `'9999'` ο tracker θα κολλήσει και θα συνεχίσει να περιστρέφεται ασταμάτητα.
Αυτό πρέπει να αποφευχθεί μέσω του προγραμματισμού του. Μελλοντικά μπορεί να προστεθεί κάποιος μηχανικός ή ηλεκτρικός μηχανισμός περιορισμού.

Εάν το βήμα γίνει ακατάλληλο και ο tracker περιστρέφεται ασταμάτητα, μπορεί να σταματήσει με την εντολή `'stop'`.
Σε αυτήν την περίπτωση, αν ερωτηθεί για τη θέση του επιστρέφει την τιμή `'9999'`.

Όταν ο ηλιοστάτης τροφοδοτείται και είναι σε λειτουργία, οι κινητήρες δεν θα επιτρέψουν την ελεύθερη περιστροφή των αξόνων.
Σε περίπτωση που χρειάζεται να περιστραφούν ελεύθερα, πρέπει να διακοπεί η τροφοδοσία. **Σημείωση**: για το πρώτο/παλιό μοντέλο του ηλιοστάτη (ορθογώνιο παραλληλόγραμμο καπάκι) η αντίσταση των κινητήρων σε εξωτερική περιστροφή είναι πολύ μικρή, με αποτέλεσμα να είναι εύκολη η τυχαία μετατόπισή του από εξωτερικούς παράγοντες.
Σε αυτή την περίπτωση, είναι καλό να γίνει επανεκκίνηση του προγράμματος ελέγχου του tracker, ώστε να ξαναβρεί τη θέση του κάνοντας reset των αξόνων και στην συνέχεια, να ελεγχθεί αν η διόπτευση (sighting) συνεχίζει να είναι σωστή.


## Παράμετροι επικοινωνίας με τον microcontroller του tracker.

Στον Πίνακα \@ref(tab:trackerserial) περιγράφονται οι απαραίτητες παράμετροι για την σύνδεση με τη σειριακή θύρα του tracker. Κατά την επικοινωνία, είναι χρήσιμο να υπάρχει και κάποιο άνω όριο στον χρόνο που περιμένει ο υπολογιστής, πριν αποφασίσει ότι η επικοινωνία δεν είναι εφικτή. Διαφορετικά, αν κάποιο μήνυμα περιμένει να διαβαστεί από τη θύρα και αυτό δεν γίνει, μπορεί να παγώσει η επικοινωνία.

\footnotesize

: (\#tab:trackerserial) Παράμετροι επικοινωνίας του tracker μέσω σειριακής θύρας RS-232.

-------------------------  ----------------------
      **bits per second**  **4800** (baudrate)
            **data bits**  **8** (bytesize)
               **parity**  **none**
            **stop bits**  **1**
          **row control**  **none**
   **timeout** (optional)  90 sec
-------------------------  ----------------------

\normalsize


## Εντολές tracker.

### Μορφή εντολών (format).

Η επικοινωνία με τον microcontroller του tracker γίνεται με εντολές που στέλνονται μέσω σειριακής θύρας επικοινωνίας. Οι εντολές έχουν την μορφή κειμένου 'string' το οποίο τερματίζεται με το σύμβολο `'cr'` ή `'\r'` ('carriage return' το τυπικό 'enter' των MS Windows).

Οι εντολές που έχουν ως όρισμα αριθμό βημάτων, πρέπει να δίνονται με διαμόρφωση τεσσάρων ψηφίων. Όταν είναι αναγκαίο πρέπει να προπορεύονται από τα αντίστοιχα μηδενικά (padded with zero). Για παράδειγμα 1000, 0999, 0099, 0001. Αυτό ισχύει για την απόλυτη θέση (π.χ. `'AZ=0100'`) και για τη σχετική μετατόπιση (`'AZ+0100'`).

Αντίστοιχα, οι εντολές που αφορούν ταχύτητες έχουν την ίδια λογική μόνο που χρησιμοποιούν δύο ψηφία.

**Προσοχή:** Η απάντηση κάθε εντολής (ανάλογα και με τις ρυθμίσεις της σειριακής επικοινωνίας) πρέπει να διαβαστεί από τη σειριακή σύνδεση γιατί διαφορετικά δεν θα αδειάσει το buffer της σειριακής θύρας και μπορεί να παγώσει η επικοινωνία.


### Μηδενισμός του βήματος του microcontroller.

Οι εντολές reset του Πίνακα \@ref(tab:trackercomstr) επιστρέφουν τους κινητήρες στην αρχική τους ('μηδενική') θέση. 
Ο microcontroller αναλαμβάνει την κίνηση. Τους περιστρέφει μέχρι την φωτοδίοδο και εκεί ρυθμίζει το εσωτερικό βήμα κάθε άξονα στη τιμή `5000`. 
Μετά την εκτέλεση της εντολής ο tracker επιστρέφει τη διαφορά στη θέση από τον προηγούμενο μηδενισμό. Αυτές οι εντολές συνήθως χρησιμοποιούνται κατά την εκκίνηση της λειτουργίας ώστε να βεβαιωθούμε για την απόλυτη θέση του tracker, αφού δεν υπάρχει άλλος μηχανισμός αναγνώρισης της θέσης.
Προσοχή, για την σωστή λειτουργία του μηδενισμού, οι παρακάτω εντολές πρέπει να δοθούν ξεχωριστά (όχι σε stack) και να περιμένουμε τον μηδενισμό του κάθε άξονα με την αντίστοιχη απάντηση από τον Tracker προτού δοθεί η επόμενη εντολή. Έπειτα από τον μηδενισμό του κάθε άξονα πρέπει να δοθεί εντολή κίνησης του ίδιου άξονα πριν δοθεί εντολή μηδενισμού του επόμενου άξονα, αλλιώς δημιουργείται πρόβλημα στην επικοινωνία και ο Tracker στην συνέχεια δεν επιστρέφει την απάντηση OK όταν μεταβεί σε κάποια ζητούμενη θέση. Υποθέτοντας ότι η θέση του αζιμούθιου, του ζενίθ και του φίλτρου της φωτοδιόδου είναι 5000, προτείνεται μετά από τον μηδενισμό του κάθε άξονα η κίνηση του ίδιου άξονα στην θέση 5000 (δεν θα μετακινηθεί αφού ήδη βρίσκεται σε αυτήν την θέση, ωστόσο αποφεύγεται το πρόβλημα της επικοινωνίας).

\footnotesize

--------------------------------------------------------------------------------------
    Εντολή          Λειτουργία                    Απάντηση tracker
----------------  ----------------------------  --------------------------------------
  **`DA`**\<cr\>      reset azimuth motor           `eA:####` (όταν βρει τη φωτοδίοδο)

  **`DF`**\<cr\>      reset filters (not used)      `eF:####` (όταν βρει τη φωτοδίοδο)

  **`DZ`**\<cr\>      reset zenith motor            `eZ:####` (όταν βρει τη φωτοδίοδο)
----------------  ----------------------------  --------------------------------------

: (\#tab:trackercomstr) Εντολές μηδενισμού (reset) των αξόνων του tracker.

\normalsize


### Κίνηση των αξόνων.

Η εντολές για την κίνηση των αξόνων έχουν τρία μέρη και έχουν τη γενική μορφή:  **`xx@####<cr>`**. Η εξήγηση των επιμέρους στοιχείων γίνεται στον Πίνακα \@ref(tab:trackercompart) και \@ref(tab:trackercomoper). Παραδείγματα έγκυρων εντολών βρίσκονται στον Πίνακα \@ref(tab:trackercomexamp). Ενώ, το σύνολο των εντολών παρατίθεται στον Πίνακα \@ref(tab:trackercommands).

\footnotesize

------------------------------------------------------------------------
  Παράμετρος  Λειτουργία
------------  ----------------------------------------------------------
  **`xx`**    Η παράμετρος στην οποία αναφέρεται

  `@`         Ο modifier της λειτουργίας που εκτελείται ( ?, =, +, - )

  **`####`**  Αριθμητική τιμή της εντολής (##: για τις ταχύτητες)

  \<cr\>      Ο χαρακτήρας τερματισμού της εντολής.
------------  ----------------------------------------------------------

Table: (\#tab:trackercompart) Τα μέρη της εντολής του tracker.


--------------------------------------------------------------------------------------------------------
 Modifier (@)   Λειτουργία                                                         Απάντηση
--------------  -----------------------------------------------------------------  -----------------------
    **`?`**     Ζητά την τιμή της μεταβλητής από τον tracker (χωρίς `####`)          xx:####\<cr\> ή xx:##\<cr\> για τις παραμέτρους ταχύτητας

    **`=`**     Θέτει την τιμή της μεταβλητής σε αυτήν την τιμή                    OK\<cr\>
                (`##` για τις παραμέτρους ταχύτητας και `####` για τις
                υπόλοιπες παραμέτρους)             

    **`+`**     Αυξάνει την τιμή της μεταβλητής κατά τη δοσμένη τιμή               OK\<cr\>
                (`##` για τις παραμέτρους ταχύτητας και `####` για τις 
                υπόλοιπες παραμέτρους)        

    **`-`**     Μειώνει την τιμή της μεταβλητής κατά τη δοσμένη τιμή               OK\<cr\>
                (`##` για τις παραμέτρους ταχύτητας και `####` για τις
                υπόλοιπες παραμέτρους)       
--------------  -----------------------------------------------------------------  -----------------------

Table: (\#tab:trackercomoper) Παράμετροι ελέγχου (operators/modifiers) εντολών tracker.


---------------------------------------------------------------------------------------------
                 Εντολές  Μέγεθος
------------------------  -------------------------------------------------------------------
   **`AZ@####`**\<cr\>    Αζιμούθιο βήμα

   **ZE@\#\#\#\#**\<cr\>  Ζενίθιο βήμα

   **FR@\#\#\#\#**\<cr\>  Βήμα φίλτρου

       **SA@\#\#**\<cr\>  Ταχύτητα αζιμούθιου άξονα

       **SZ@\#\#**\<cr\>  Ταχύτητα ζενίθιου άξονα

       **SF@\#\#**\<cr\>  Ταχύτητα φίλτρου

   **OA@\#\#\#\#**\<cr\>  Τροποποίηση αρχικής αζιμούθιας θέσης

   **OZ@\#\#\#\#**\<cr\>  Τροποποίηση αρχικής ζενίθιας θέσης

   **OF@\#\#\#\#**\<cr\>  Τροποποίηση αρχικής θέσης φίλτρου

   **IA@\#\#\#\#**\<cr\>  Τροποποίηση της αζιμούθιας θέσης της φωτοδιόδου

   **IZ@\#\#\#\#**\<cr\>  Τροποποίηση της ζενίθιας θέσης της φωτοδιόδου

   **IF@\#\#\#\#**\<cr\>  Τροποποίηση της θέσης του φίλτρου της φωτοδιόδου
   
   **TA@\#\#\#\#**\<cr\>  Τροποποίηση της ζητούμενης αζιμούθιας θέσης (μόνο ερώτηση)

   **TZ@\#\#\#\#**\<cr\>  Τροποποίηση της ζενίθιας αζιμούθιας θέσης (μόνο ερώτηση)

   **TF@\#\#\#\#**\<cr\>  Τροποποίηση της ζητούμενης θέσης του φίλτρου (μόνο ερώτηση)

  **GO XXXX,YYYY**\<cr\>  Μετακινεί ταυτόχρονα την αζιμούθια και ζενίθια θέση σε XXXX και YYYY βήματα αντίστοιχα

          **STOP**\<cr\>  Σταματά την κίνηση του tracker

 **DEBUG ON/OFF**\<cr\>   Toggles debug mode on/off. Στην περίπτωση του ON, ο Tracker επιστρέφει τόσο την εντολή που του δόθηκε, όσο και την αντίστοιχη απάντηση
------------------------  -------------------------------------------------------------------

Table: (\#tab:trackercommands) Εντολές tracker.

\normalsize


Η εντολή **`stop<cr>`** σταματά την κίνηση των αξόνων. Λειτουργεί ακόμα και όταν ο tracker έχει 'κολλήσει'. Όταν δηλαδή, το βήμα κάποιου άξονα έχει φτάσει σε μη επιτρεπτή τιμή. Σε αυτή τη κατάσταση, ο tracker απαντά την τιμή `9999` στο ερώτημα της θέσης, ενώ ο άξονας περιστρέφεται ασταμάτητα.

\footnotesize

--------------------------------------------------------------------------------
   Εντολή              Αποτέλεσμα
---------------------  ---------------------------------------------------------
  **AZ=6000**\<cr\>    Αζιμούθιο στη θέση 6000

  **ZE+0010**\<cr\>    Ζενίθ +10 βήματα

  **AZ-0100**\<cr\>    Αζιμούθιο -100 βήματα

  **AZ?**\<cr\>        Απάντηση: AZ:5900\<cr\>

  **SA=60**\<cr\>      Ταχύτητα του αζιμούθιου άξονα 60

  **?**\<cr\>          θέσεις των δύο αξόνων και του φίλτρου. \
                       Απάντησεις:  AZ:2345\<cr\>,  ZE:5678\<cr\>, FR:3456\<cr\> 
--------------------------------------------------------------------------------

Table: (\#tab:trackercomexamp) Παραδείγματα εντολών tracker.

\normalsize

 
## Resetting USB/serial interface σε GNU/Linux.

Κάποιες ιδέες και προτάσεις για το πως μπορεί να γίνει επανασύνδεση της επικοινωνίας χωρίς να αποσυνδεθεί η φυσική σύνδεση. Έχουν παραχθεί και τα αντίστοιχα 'bash script' που μπορούν να βρουν την κατάλληλη USB συσκευή και να εκτελέσουν τις παρακάτω ενέργειες.


### Αποσύνδεση των αντίστοιχων module/firmware από τον kernel.

Αυτές οι εντολές απενεργοποιούν και ενεργοποιούν τα κομμάτια του συστήματος που χειρίζονται τις σειριακές συσκευές και τις συσκευές USB.

```{bash eval=F}
rmmod  ftdi_sio
rmmod  usbserial
modprobe ftdi_sio
modprobe usbserial
```


### Αποσύνδεση της συσκευής από το σύστημα.

Οι παρακάτω εντολές στέλνουν ένα σήμα σύνδεσης και αποσύνδεσης στην συσκευή USB.

```{bash eval=F}
sudo sh -c "echo 0 > /sys/bus/usb/devices/1-1/authorized"
sudo sh -c "echo 1 > /sys/bus/usb/devices/1-1/authorized"
```


### Αποσύνδεση του mountpoint από το σύστημα (untested).

Αν και δεν έχουν δοκιμαστεί, οι εντολές αυτής της μορφής μπορούν να αποσυνδέσουν και να επανασυνδέσουν την διαδρομή αρχείου που αντιστοιχεί στην συσκευή και επομένως να ανανεώσουν την επικοινωνία.

```{bash eval=F} 
unbind ...
bind   ...
```



    


# Ηλεκτρικά - Μηχανικά Χαρακτηριστικά.

## Κινητήρες tracker (57SH56-4AM)

```{r spmspec, out.width=".94\\linewidth", include=TRUE, echo=FALSE }
system("convert -density 300 ./files/57SH56-4AM_400_STEP.pdf -crop 2300x3390+100+70 -quality 100 ./files/57SH56-4AM_400_STEP.png")
knitr::include_graphics("./files/57SH56-4AM_400_STEP.png")
```


## Κινητήρες filter wheel (G11)


```{r fwspec, out.width="1\\linewidth", include=TRUE, echo=FALSE}
system("convert -density 300 ./files/FWmotor.pdf -crop 2250x3220+120+100 -quality 100 ./files/FWmotor.png")
knitr::include_graphics('./files/FWmotor.png')
```

```{r fwwire, out.width="1\\linewidth", include=TRUE, echo=FALSE}
system("convert -density 300 ./files/FWmotor_wiring.pdf -crop 2320x3240+80+70 -quality 100 ./files/FWmotor_wiring.png")
knitr::include_graphics('./files/FWmotor_wiring.png')
```

## Τροφοδοσία ισχύος

Το τροφοδοτικό του tracker παρέχει συνεχή διαφορά δυναμικού $19-20\ V$. Για την ώρα δεν γνωρίζουμε την δυνατότητα σε ισχύ της συσκευής ούτε φυσικά και το μέγιστο ηλεκτρικό ρεύμα που μπορεί να παρέχει.


<!--chapter:end:030-operation.Rmd-->


\newpage

# Εγκατάσταση του tracker. {#trackerinstallation}

Είναι αναγκαίο το επίπεδο τις συσκευής να είναι απολύτως οριζόντιο, αλλά και να διατηρείται κατά τη λειτουργία του συστήματος tracker-οργάνου. Γι' αυτό η βάση, πρέπει να είναι αρκετά σταθερή αλλά και να έχει τη δυνατότητα λεπτομερούς ρύθμισης του επιπέδου. Στη συνέχεια θα περιγράψουμε την ρύθμιση του οργάνου για την παρακολούθηση της πορείας του Ήλιου.

```{r trackercompass, echo=F, fig.cap="Δορυφορική φωτογραφία της τοποθεσίας μετρήσεων (κόκκινο). Έχουν σχεδιαστεί οι κατευθύνσεις που αντιστοιχούν στα σημεία του ορίζοντα (μπλε), το αζιμούθιο του ήλιου κατά την ανατολή και τη δύση στις 21 Ιουλίου (κίτρινο) και αντίστοιχα στις 21 Δεκεμβρίου (πράσινο). Όλες οι γωνίες είναι μετρημένες με αρχή την κατεύθυνση του Βορρά.", out.width = '100%', fig.env='img'}
knitr::include_graphics("figure/compass.png")
```
<!-- convert -density 300 compass.pdf -shave 204x0 -quality 100 ccc.pdf -->
<!-- convert -density 300 -quality 100 ccc.pdf compass.png -->


## Ρύθμιση αζιμούθιου άξονα.

Πρώτο βήμα, είναι η ευθυγράμμιση του μηδέν του αζιμούθιου της συσκευής με τον Βορρά. Αυτό μπορεί να γίνει με άμεση ευθυγράμμιση, αν η θέση του Βορρά είναι γνωστή (Εικόνα \ref{fig:trackercompass}). Εναλλακτικά, μπορεί να γίνει όταν η συσκευή είναι ενεργή και ακολουθεί τον ήλιο. Τότε, η διόπτευση του ήλιου μπορεί να χρησιμοποιηθεί για να ευθυγραμμίσει το αζιμούθιο με τον Βορρά. Και στις δύο περιπτώσεις η συσκευή πρέπει να τοποθετηθεί στη βάση της και να μπορεί να περιστραφεί πριν σταθεροποιηθεί στην τελική της θέση. Περαιτέρω, βελτίωση της θέσης του μηδενός του αζιμουθιακού άξονα, μπορεί να γίνει προγραμματιστικά, με τις μεταβλητές του offset στο πρόγραμμα που τις ελέγχει.


## Ρύθμιση ζενίθιου άξονα.

Για τον ζενίθιο άξονα, δεν θα χρειαστεί κάποια διαδικασία από τη στιγμή που η συσκευή είναι οριζοντιωμένη. Αν γνωρίζουμε τη θέση αναφοράς όπου μηδενίζει το όργανο, μπορούμε να υπολογίσουμε την θέση που ο άξονας θα βρίσκεται στο ζενίθ ή κάθετα σε αυτό (ανάλογα με τη βάση πρόσδεσης του οργάνου). Έτσι, μπορούμε να θέσουμε αυτήν την παράμετρο στο πρόγραμμα που ελέγχει τη συσκευή. Μία άλλη προσέγγιση, για να βρούμε το offset της στόχευσης, είναι η προσάρτηση του οργάνου να γίνει ενώ ο tracker ακολουθεί τον ήλιο, ώστε να ευθυγραμμιστεί με αυτόν. Αυτό προϋποθέτει ότι η στερέωση του οργάνου μπορεί να γίνει σε οποιαδήποτε γωνία σε σχέση με τον άξονα.


## Οριζοντίωση του ηλιοστάτη (leveling).

Τέλος, έχουμε την καθετοποίηση του οργάνου, ώστε ο άξονας του αζιμούθιου να είναι κατακόρυφος στη Γη. Μετά την τοποθέτηση των οργάνων μέτρησης, αλλά και περιοδικά, η καθετότητα του άξονα πρέπει να ελέγχεται. Καθώς, αποκλίσεις μπορούν να προκαλέσουν εσφαλμένες μετρήσεις κατά τη διάρκεια της ημέρας. Η ανάγκη αυτή, μπορεί να φανεί όταν μετά από διόπτευση (sighting) του Ήλιου, ο tracker χάνει γρήγορα την ευθυγράμμισή του.

Ξεκινάμε με τον tracker χωρίς τροφοδοσία, ώστε να μπορεί να περιστραφεί ελεύθερα γύρω από τον κατακόρυφο άξονα. Για τον έλεγχο της στάθμης χρησιμοποιούμε αλφάδι φυσαλίδας (αεροστάθμη) με δυνατότης ανεξάρτητης ρύθμισης του επιπέδου του σε σχέση με το όργανο, όπως φαίνεται στην Εικόνα \@ref(fig:trackerleveling).


```{r trackerleveling, echo=F, fig.cap="Οριζοντίωση του tracker. Φαίνεται ο tracker εγκατεστημένος σε ρυθμιζόμενη βάση (τρίποδο) και η αεροστάθμη (αλφάδι) με την οποία ελέγχεται η οριζοντίωση.", out.width = '80%', fig.env='img'}
knitr::include_graphics("/home/athan/Aerosols/Photos/EL/20160307_Tracker_CHP1_CCD/P1110530.JPG")
```

Θα ρυθμίσουμε κάθε σημείο ελευθερίας του επιπέδου (εδώ, κάθε πόδι της βάσης) διαδοχικά, μέχρι το επίπεδο του οργάνου να συμφωνεί με το επίπεδο αναφοράς της στάθμης. Σε όλη τη διαδικασία δεν πρέπει να αλλάξουμε τη θέση του οργάνου της στάθμης πάνω στο όργανο.

Η διαδικασία για κάθε πόδι έχει ως εξής:
Φέρνουμε τον άξονα της φυσαλίδας παράλληλο με την διεύθυνση του ποδιού. Αλλάζουμε το ύψος του και ρυθμίζουμε ξανά το όργανο στάθμης, προσπαθώντας να μοιράσουμε την μεταβολή ισόποσα μεταξύ των δύο. Περιστρέφουμε τον tracker κατά $180^\circ$ και επαναλαμβάνουμε τη ρύθμιση και των δύο.

Το παραπάνω βήμα, το επαναλάβουμε μέχρι η στάθμη να είναι ικανοποιητικά επίπεδη. Με τον ίδιο τρόπο ρυθμίζουμε διαδοχικά και τα υπόλοιπα πόδια. Πιθανότατα, θα χρειαστεί παραπάνω από ένας κύκλος ρυθμίσεων και για το κάθε πόδι, αλλά και για τα τρία σε αλληλουχία. Το πλήθος τους, θα εξαρτηθεί από την ευαισθησία του μηχανισμού ρύθμισης, την ικανότητα του χειριστή αλλά και το επιθυμητό επίπεδο ακρίβειας.

Επαναλαμβάνουμε ότι είναι σημαντική η περιστροφή tracker μαζί με όργανο στάθμης κατά $180^\circ$, διότι πρέπει να ληφθεί υπόψη ότι το κάλυμμα του οργάνου δεν είναι κατ' ανάγκη παράλληλο με τη βάση του (π.χ. μπορεί να έχει παραμορφωθεί).


<!--chapter:end:040-installation.Rmd-->

\newpage

`r if( knitr:::is_latex_output()) '\\appendix'`
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-#appendix}'`


CHP-1 Quick startup (on 'radmon' computer).
===========================================

<!-- \vspace{-1.5\baselineskip}  -->
Σύνδεση του tracker. {-}
------------------------
\vspace{-0.6\baselineskip}

Στο τροφοδοτικό του tracker συνδέονται τρία καλώδια.
Συνήθως, η σύνδεση πετυχαίνει αν τα καλώδια συνδεθούν με τη σειρά από δεξιά προς τα αριστερά ή το αντίθετο.
Η εκτέλεση του προγράμματος θα δείξει αν η επικοινωνία μπορεί να γίνει σωστά.

\vspace{-1.05\baselineskip}
Reset tracker. {-}
-------------------
\vspace{-0.6\baselineskip}

Όταν ο tracker τροφοδοτείται τα ηλεκτρονικά του είναι ενεργά, μερικές φορές, αυτό αποτρέπει την επανασύνδεση.
Για να λυθεί αυτό ή πρέπει να μείνει για μερικά λεπτά χωρίς τροφοδοσία, ή να βραχυκυκλωθούν οι επαφές που τροφοδοτούν την ηλεκτρονική πλακέτα του tracker.
**ΠΡΟΣΟΧΗ: εφαρμόστε λογική και αποσυνδέστε πρώτα την τροφοδοσία ρεύματος**.
Αν το περίβλημα του tracker είναι ανοικτό, οι επαφές είναι προσβάσιμες. Εναλλακτικά, μπορούν να βραχυκυκλωθούν οι επαφές του καλωδίου με κάποιο μεταλλικό αντικείμενο και μόνο από τη μεριά του καλωδίου που συνδέεται στο τροφοδοτικό, ώστε να είστε σίγουροι για τη κατάσταση τροφοδοσίας.

\vspace{-1.05\baselineskip}
Εκκίνηση του προγράμματος ελέγχου {-}
-------------------------------------
\vspace{-0.6\baselineskip}

Το πρόγραμμα ελέγχου του tracker (**sun_tracker_main.py**) μπορεί να ξεκινήσει:

* Χειροκίνητα (link στην επιφάνεια εργασίας)
* Μέσω του 'Scheduled Tasks' (properties -\> run)
* Εκτέλεση από command line (cmd.exe):
```{bash eval=F}
c:\><python path>\python.exe <script path>\sun_tracker_main.py
```


\vspace{-1.05\baselineskip}
Διόπτευση (sighting) {-}
-------------------------
\vspace{-0.6\baselineskip}

Το sighting του Ήλιου μπορεί να γίνει με το πρόγραμμα **tracker_sighting_no_ui_tcp-port.py** (υπάρχει link στην επιφάνεια εργασίας).
Το πρόγραμμα εμφανίζει τις δυνατές επιλογές στην οθόνη και περιμένει είσοδο από το πληκτρολόγιο.
Οι ρυθμίσεις επιδρούν άμεσα στη θέση του tracker (το πρόγραμμα **sun_tracker_main.py** πρέπει να εκτελείται και ο tracker πρέπει να έχει αρχίσει την κανονική λειτουργία).
Ανάδραση (feedback) των ρυθμίσεων μπορούμε να έχουμε παρακολουθώντας το terminal που τρέχει το **sun_tracker_main.py**. **ΠΡΟΣΟΧΗ.** Οι ρυθμίσεις πρέπει να σωθούν (`'s'`) για να αποθηκευτούν στον δίσκο και να διατηρηθούν στην επόμενη εκτέλεση (ημέρα).

**Σημείωση:** Είναι βολικό το sighting να γίνεται με κάποιο smart phone μέσω remote desktop ('rdp').
Έτσι, μπορεί να υπάρχει άμεση επίβλεψη της κίνησης του tracker και των διορθώσεων και διευκολύνεται ο συγχρονισμός της κίνησης του tracker με τη θέση του ήλιου.

\vspace{-1.05\baselineskip}
Σύνδεση πολυμέτρου 'Protek 506' {-}
--------------------------------------------------------------------------------
\vspace{-0.6\baselineskip}
Το πολύμετρο μετράει την αντίσταση του pt100 ή του θερμίστορ (χρωματισμός καλωδίων στο manual του CHP) και η μέτρηση διαβάζεται μέσω 'RS-232'.
Στο πολύμετρο πρέπει να είναι ενεργές οι επιλογές '*KEEP ON*' και '*RS232*'. Αυτό γίνεται με τα πλήκτρα 'menu' και 'enter' για κάθε μία από τις ρυθμίσεις.


\vspace{-1.05\baselineskip}
Εκκίνηση προγράμματος πολυμέτρου {-}
-------------------------------------
\vspace{-0.6\baselineskip}

Το πρόγραμμα (**protek506_measurments.py**) παίρνει μετρήσεις της αντίστασης - θερμοκρασίας του CHP1 και μπορεί να εκτελεστεί με όμοιο τρόπο με το πρόγραμμα του tracker.
Καθώς το πρόγραμμα παίρνει μετρήσεις, στη οθόνη του πολυμέτρου πρέπει να αναβοσβήνουν εναλλάξ οι ενδείξεις '*RX*' και '*TX*'.
Αν αυτό δεν γίνεται τότε η επικοινωνία έχει κολλήσει και το πολύμετρο πρέπει να κλείσει, να ξανανοίξει και να ρυθμιστεί (όπως παραπάνω).

\vspace{-1.05\baselineskip}
Σε περίπτωση διακοπής ρεύματος. {-}
------------------------------------
\vspace{-0.6\baselineskip}
Έχει παρατηρηθεί ότι ο tracker μπορεί να ξεκινήσει κανονικά όταν επανέλθει η τροφοδοσία και ξεκινήσει ο υπολογιστής. Αλλά αυτό δεν γίνεται πάντα.


\vspace{-1\baselineskip}
Scheduled script description {-}
---------------------------------
\vspace{-0.7\baselineskip}

Τα παρακάτω script εκτελούνται συνεχώς από το 'Task Scheduler' και σχετίζονται με τη καθημερινή λειτουργία του tracker και του CPH1, και είναι:

* **sun_tracker_main.py**       (απαραίτητο, ελέγχει την κίνηση του tracker)
* **protek506_measurments.py**  (σημαντικό, μετράει την θερμοκρασία του CPH1)
* **data_pub_win.py**           (βοηθητικό, εκπέμπει δεδομένα λειτουργίας του tracker)

**Σημείωση:** Σε περίπτωση που κάποιο από αυτά ήδη εκτελείται δεν θα ξανατρέξει, διότι υπάρχει εσωτερικός έλεγχος στον κώδικα του κάθε προγράμματος.

**Σημείωση:** Πρέπει να είναι είναι ενεργή η επιλογή: `"Disable error reporting"` ώστε να μην κολλάει ο tracker περιμένοντας τον διάλογο του "Error reporting" όταν crashάρει. Πιθανόν και η επιλογή `"But notify me when critical error occurs"` (υπό δοκιμή για την ώρα). Για *Windows XP: Control Panel > System > Advanced > Error reporting*.



# Tracker microcontroler source code

\tiny



```{r echo=F, include=T, eval=T, comment=NA, size="tiny",highlight='tango'}
cat(
readLines("/home/athan/Aerosols/borrowed source/Tracker LAP/Tracker v1.6.C"), sep = "\n"
)
```

\normalsize




<!--chapter:end:150-appendix.Rmd-->

